{% extends 'base.html' %}

{% block title %}Dashboard - Cloud Services Cost Manager{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
    <h1>Cost Dashboard</h1>
    <p class="text-muted">Visualize and analyze your cloud service costs</p>
</div>

<div class="card mb-4 filter-card">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-filter text-primary me-2 fa-lg"></i>
                    <h5 class="mb-0">Filter Dashboard</h5>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="month-select" class="form-label">Month</label>
                            <select class="form-select" id="month-select">
                                <option value="all">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="year-select" class="form-label">Year</label>
                            <select class="form-select" id="year-select">
                                <option value="all">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-4">
        <div class="card h-100 chart-card">
            <div class="card-header bg-gradient-primary">
                <div class="d-flex align-items-center">
                    <i class="fas fa-server me-2"></i>
                    <h5 class="mb-0">Costs by Environment</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="costsByEnvironmentChart"></canvas>
                </div>
                <div id="envChartLoading" class="chart-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="envChartNoData" class="chart-no-data d-none">
                    <i class="fas fa-chart-pie fa-3x text-muted"></i>
                    <p>No data available for the selected period</p>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">Total cost distribution by environment</small>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100 chart-card">
            <div class="card-header bg-gradient-success">
                <div class="d-flex align-items-center">
                    <i class="fas fa-cubes me-2"></i>
                    <h5 class="mb-0">Costs by Service</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="costsByServiceChart"></canvas>
                </div>
                <div id="serviceChartLoading" class="chart-loading">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="serviceChartNoData" class="chart-no-data d-none">
                    <i class="fas fa-chart-pie fa-3x text-muted"></i>
                    <p>No data available for the selected period</p>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">Cost breakdown by individual services</small>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100 chart-card">
            <div class="card-header bg-gradient-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tags me-2"></i>
                    <h5 class="mb-0">Costs by Category</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="costsByCategoryChart"></canvas>
                </div>
                <div id="categoryChartLoading" class="chart-loading">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="categoryChartNoData" class="chart-no-data d-none">
                    <i class="fas fa-chart-pie fa-3x text-muted"></i>
                    <p>No data available for the selected period</p>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">Cost distribution by service category</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card chart-card">
            <div class="card-header bg-gradient-warning">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <i class="fas fa-chart-line me-2"></i>
                        <h5 class="mb-0 d-inline">Monthly Cost Trend</h5>
                    </div>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-light" id="monthlyViewBtn">Monthly</button>
                        <button class="btn btn-sm btn-light" id="quarterlyViewBtn">Quarterly</button>
                        <button class="btn btn-sm btn-light" id="yearlyViewBtn">Yearly</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:300px;">
                    <canvas id="costTrendChart"></canvas>
                </div>
                <div id="trendChartLoading" class="chart-loading">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="trendChartNoData" class="chart-no-data d-none">
                    <i class="fas fa-chart-line fa-3x text-muted"></i>
                    <p>No trend data available</p>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">Shows how your costs have changed over time</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card chart-card">
            <div class="card-header bg-gradient-danger">
                <div class="d-flex align-items-center">
                    <i class="fas fa-layer-group me-2"></i>
                    <h5 class="mb-0">Environment Cost Breakdown</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="env-selector-heading mb-2">
                            <i class="fas fa-filter me-1 text-muted"></i>
                            <span>Select Environment</span>
                        </div>
                        <div class="environment-list">
                            {% for environment in environments %}
                            <div class="env-item">
                                <a href="#" class="btn btn-outline-danger w-100 text-start mb-2 environment-selector" data-environment="{{ environment }}">
                                    <i class="fas fa-server me-2"></i> {{ environment }}
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="chart-container" style="position: relative; height:350px;">
                            <canvas id="environmentBreakdownChart"></canvas>
                        </div>
                        <div id="envBreakdownLoading" class="chart-loading">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="noDataMessage" class="chart-no-data d-none">
                            <i class="fas fa-chart-bar fa-3x text-muted"></i>
                            <p>No data available for the selected environment and time period</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">Detailed breakdown of costs for each environment by service</small>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row -->
<div class="row mt-4">
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="summary-icon bg-primary-light me-3">
                        <i class="fas fa-dollar-sign text-primary"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Total Cost</h6>
                        <h3 id="totalCost" class="mb-0">$0.00</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="summary-icon bg-success-light me-3">
                        <i class="fas fa-server text-success"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Service Count</h6>
                        <h3 id="serviceCount" class="mb-0">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="summary-icon bg-info-light me-3">
                        <i class="fas fa-layer-group text-info"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Environments</h6>
                        <h3 id="envCount" class="mb-0">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="summary-icon bg-warning-light me-3">
                        <i class="fas fa-tags text-warning"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Categories</h6>
                        <h3 id="categoryCount" class="mb-0">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}">

    // Function to update all dashboard charts based on filters
    function updateDashboard() {
        const selectedMonth = document.getElementById('month-select').value;
        const selectedYear = document.getElementById('year-select').value;

        // Show loading states
        showLoading();

        // Update all charts with new filter values
        loadCostsByCategoryChart(selectedMonth, selectedYear);
        loadCostsByEnvironmentChart(selectedMonth, selectedYear);
        loadCostsByServiceChart(selectedMonth, selectedYear);
        loadCostTrendChart(selectedMonth, selectedYear);

        // Reset environment breakdown chart (it will be updated on selection)
        resetEnvironmentBreakdownChart();

        // Update summary metrics
        loadSummaryData(selectedMonth, selectedYear);

        // Refresh environment selectors with new filters
        setupEnvironmentSelectors();
    }

    // Function to show loading indicators
    function showLoading() {
        document.getElementById('envChartLoading').classList.remove('d-none');
        document.getElementById('serviceChartLoading').classList.remove('d-none');
        document.getElementById('categoryChartLoading').classList.remove('d-none');
        document.getElementById('trendChartLoading').classList.remove('d-none');
        document.getElementById('envBreakdownLoading').classList.remove('d-none');

        document.getElementById('envChartNoData').classList.add('d-none');
        document.getElementById('serviceChartNoData').classList.add('d-none');
        document.getElementById('categoryChartNoData').classList.add('d-none');
        document.getElementById('trendChartNoData').classList.add('d-none');
        document.getElementById('noDataMessage').classList.add('d-none');
    }

    // Function to reset environment breakdown chart
    function resetEnvironmentBreakdownChart() {
        if (environmentBreakdownChart) {
            environmentBreakdownChart.destroy();
            environmentBreakdownChart = null;
        }
        document.getElementById('noDataMessage').classList.add('d-none');
    }

    // Function to load summary data
    function loadSummaryData(month = 'all', year = 'all') {
        // Call your API to get summary metrics
        fetch(`/api/dashboard_summary?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalCost').textContent = '$' + data.total_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('serviceCount').textContent = data.service_count;
                document.getElementById('envCount').textContent = data.environment_count;
                document.getElementById('categoryCount').textContent = data.category_count;
            })
            .catch(error => {
                console.error('Error loading summary data:', error);
                // Set default values on error
                document.getElementById('totalCost').textContent = '$0.00';
                document.getElementById('serviceCount').textContent = '0';
                document.getElementById('envCount').textContent = '0';
                document.getElementById('categoryCount').textContent = '0';
            });
    }

    // Function to change trend chart view mode
    function changeViewMode(mode) {
        // Highlight the active button
        document.getElementById('monthlyViewBtn').classList.remove('btn-warning');
        document.getElementById('monthlyViewBtn').classList.add('btn-light');
        document.getElementById('quarterlyViewBtn').classList.remove('btn-warning');
        document.getElementById('quarterlyViewBtn').classList.add('btn-light');
        document.getElementById('yearlyViewBtn').classList.remove('btn-warning');
        document.getElementById('yearlyViewBtn').classList.add('btn-light');

        // Highlight selected button
        document.getElementById(`${mode}ViewBtn`).classList.remove('btn-light');
        document.getElementById(`${mode}ViewBtn`).classList.add('btn-warning');

        // Update chart with the selected view mode
        const selectedMonth = document.getElementById('month-select').value;
        const selectedYear = document.getElementById('year-select').value;
        loadCostTrendChart(selectedMonth, selectedYear, mode);
    }
        // Initialize filter values
        const currentDate = new Date();
        document.getElementById('year-select').value = currentDate.getFullYear().toString();

        // Set up filter change listeners
        document.getElementById('month-select').addEventListener('change', updateDashboard);
        document.getElementById('year-select').addEventListener('change', updateDashboard);

        // Set up view buttons for trend chart
        document.getElementById('monthlyViewBtn').addEventListener('click', () => changeViewMode('monthly'));
        document.getElementById('quarterlyViewBtn').addEventListener('click', () => changeViewMode('quarterly'));
        document.getElementById('yearlyViewBtn').addEventListener('click', () => changeViewMode('yearly'));

        // Load summary metrics
        loadSummaryData();

        // Initial dashboard load
        updateDashboard();
    });

    // Function to update all dashboard charts based on filters
    function updateDashboard() {
        const selectedMonth = document.getElementById('month-select').value;
        const selectedYear = document.getElementById('year-select').value;

        // Show loading states
        showLoading();

        // Update all charts with new filter values
        loadCostsByCategoryChart(selectedMonth, selectedYear);
        loadCostsByEnvironmentChart(selectedMonth, selectedYear);
        loadCostsByServiceChart(selectedMonth, selectedYear);
        loadCostTrendChart(selectedMonth, selectedYear);

        // Reset environment breakdown chart (it will be updated on selection)
        resetEnvironmentBreakdownChart();

        // Update summary metrics
        loadSummaryData(selectedMonth, selectedYear);
    }

    // Function to show loading indicators
    function showLoading() {
        document.getElementById('envChartLoading').classList.remove('d-none');
        document.getElementById('serviceChartLoading').classList.remove('d-none');
        document.getElementById('categoryChartLoading').classList.remove('d-none');
        document.getElementById('trendChartLoading').classList.remove('d-none');
        document.getElementById('envBreakdownLoading').classList.remove('d-none');

        document.getElementById('envChartNoData').classList.add('d-none');
        document.getElementById('serviceChartNoData').classList.add('d-none');
        document.getElementById('categoryChartNoData').classList.add('d-none');
        document.getElementById('trendChartNoData').classList.add('d-none');
        document.getElementById('noDataMessage').classList.add('d-none');
    }

    // Function to reset environment breakdown chart
    function resetEnvironmentBreakdownChart() {
        if (environmentBreakdownChart) {
            environmentBreakdownChart.destroy();
            environmentBreakdownChart = null;
        }
        document.getElementById('noDataMessage').classList.add('d-none');
    }

    // Function to load summary data
    function loadSummaryData(month = 'all', year = 'all') {
        // Call your API to get summary metrics
        fetch(`/api/dashboard_summary?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalCost').textContent = '$' + data.total_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('serviceCount').textContent = data.service_count;
                document.getElementById('envCount').textContent = data.environment_count;
                document.getElementById('categoryCount').textContent = data.category_count;
            })
            .catch(error => {
                console.error('Error loading summary data:', error);
                // Set default values on error
                document.getElementById('totalCost').textContent = '$0.00';
                document.getElementById('serviceCount').textContent = '0';
                document.getElementById('envCount').textContent = '0';
                document.getElementById('categoryCount').textContent = '0';
            });
    }

    // Function to change trend chart view mode
    function changeViewMode(mode) {
        // Highlight the active button
        document.getElementById('monthlyViewBtn').classList.remove('btn-warning');
        document.getElementById('monthlyViewBtn').classList.add('btn-light');
        document.getElementById('quarterlyViewBtn').classList.remove('btn-warning');
        document.getElementById('quarterlyViewBtn').classList.add('btn-light');
        document.getElementById('yearlyViewBtn').classList.remove('btn-warning');
        document.getElementById('yearlyViewBtn').classList.add('btn-light');

        // Highlight selected button
        document.getElementById(`${mode}ViewBtn`).classList.remove('btn-light');
        document.getElementById(`${mode}ViewBtn`).classList.add('btn-warning');

        // Update chart with the selected view mode
        const selectedMonth = document.getElementById('month-select').value;
        const selectedYear = document.getElementById('year-select').value;
        loadCostTrendChart(selectedMonth, selectedYear, mode);
    }

    // Load Costs by Category Chart
    function loadCostsByCategoryChart(month = 'all', year = 'all') {
        fetch(`/api/costs_by_category?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('categoryChartLoading').classList.add('d-none');

                // Check if there's data to display
                if (data.length === 0) {
                    document.getElementById('categoryChartNoData').classList.remove('d-none');
                    if (costsByCategoryChart) {
                        costsByCategoryChart.destroy();
                        costsByCategoryChart = null;
                    }
                    return;
                }

                // Destroy previous chart if it exists
                if (costsByCategoryChart) {
                    costsByCategoryChart.destroy();
                }

                const ctx = document.getElementById('costsByCategoryChart').getContext('2d');
                costsByCategoryChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.category),
                        datasets: [{
                            label: 'Cost ($)',
                            data: data.map(item => item.cost),
                            backgroundColor: [
                                'rgba(23, 162, 184, 0.8)', 'rgba(102, 16, 242, 0.8)', 
                                'rgba(253, 126, 20, 0.8)', 'rgba(32, 201, 151, 0.8)', 
                                'rgba(220, 53, 69, 0.8)', 'rgba(0, 123, 255, 0.8)', 
                                'rgba(40, 167, 69, 0.8)', 'rgba(255, 193, 7, 0.8)',
                                'rgba(108, 117, 125, 0.8)', 'rgba(52, 58, 64, 0.8)'
                            ],
                            borderColor: [
                                'rgb(23, 162, 184)', 'rgb(102, 16, 242)', 
                                'rgb(253, 126, 20)', 'rgb(32, 201, 151)', 
                                'rgb(220, 53, 69)', 'rgb(0, 123, 255)', 
                                'rgb(40, 167, 69)', 'rgb(255, 193, 7)',
                                'rgb(108, 117, 125)', 'rgb(52, 58, 64)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round(value / total * 100) : 0;
                                        return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                    }
                                },
                                titleFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 13
                                },
                                padding: 10,
                                boxPadding: 5
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading category chart:', error);
                document.getElementById('categoryChartLoading').classList.add('d-none');
                document.getElementById('categoryChartNoData').classList.remove('d-none');
            });
            }

            // Load Costs by Environment Chart
            function loadCostsByEnvironmentChart(month = 'all', year = 'all') {
        fetch(`/api/costs_by_environment?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('envChartLoading').classList.add('d-none');

                // Check if there's data to display
                if (data.length === 0) {
                    document.getElementById('envChartNoData').classList.remove('d-none');
                    if (costsByEnvironmentChart) {
                        costsByEnvironmentChart.destroy();
                        costsByEnvironmentChart = null;
                    }
                    return;
                }

                // Destroy previous chart if it exists
                if (costsByEnvironmentChart) {
                    costsByEnvironmentChart.destroy();
                }

                const ctx = document.getElementById('costsByEnvironmentChart').getContext('2d');
                costsByEnvironmentChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.environment),
                        datasets: [{
                            label: 'Cost ($)',
                            data: data.map(item => item.cost),
                            backgroundColor: [
                                'rgba(0, 123, 255, 0.8)', 'rgba(40, 167, 69, 0.8)', 
                                'rgba(255, 193, 7, 0.8)', 'rgba(220, 53, 69, 0.8)', 
                                'rgba(102, 16, 242, 0.8)', 'rgba(253, 126, 20, 0.8)', 
                                'rgba(32, 201, 151, 0.8)', 'rgba(23, 162, 184, 0.8)',
                                'rgba(108, 117, 125, 0.8)', 'rgba(52, 58, 64, 0.8)'
                            ],
                            borderColor: [
                                'rgb(0, 123, 255)', 'rgb(40, 167, 69)', 
                                'rgb(255, 193, 7)', 'rgb(220, 53, 69)', 
                                'rgb(102, 16, 242)', 'rgb(253, 126, 20)', 
                                'rgb(32, 201, 151)', 'rgb(23, 162, 184)',
                                'rgb(108, 117, 125)', 'rgb(52, 58, 64)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round(value / total * 100) : 0;
                                        return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                    }
                                },
                                titleFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 13
                                },
                                padding: 10,
                                boxPadding: 5
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading environment chart:', error);
                document.getElementById('envChartLoading').classList.add('d-none');
                document.getElementById('envChartNoData').classList.remove('d-none');
            });
            }

            // Load Costs by Service Chart
            function loadCostsByServiceChart(month = 'all', year = 'all') {
        fetch(`/api/costs_by_service?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('serviceChartLoading').classList.add('d-none');

                // Check if there's data to display
                if (data.length === 0) {
                    document.getElementById('serviceChartNoData').classList.remove('d-none');
                    if (costsByServiceChart) {
                        costsByServiceChart.destroy();
                        costsByServiceChart = null;
                    }
                    return;
                }

                // Destroy previous chart if it exists
                if (costsByServiceChart) {
                    costsByServiceChart.destroy();
                }

                const ctx = document.getElementById('costsByServiceChart').getContext('2d');
                costsByServiceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.service),
                        datasets: [{
                            label: 'Cost ($)',
                            data: data.map(item => item.cost),
                            backgroundColor: [
                                'rgba(32, 201, 151, 0.8)', 'rgba(102, 16, 242, 0.8)',
                                'rgba(253, 126, 20, 0.8)', 'rgba(23, 162, 184, 0.8)',
                                'rgba(0, 123, 255, 0.8)', 'rgba(40, 167, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)', 'rgba(220, 53, 69, 0.8)',
                                'rgba(108, 117, 125, 0.8)', 'rgba(52, 58, 64, 0.8)'
                            ],
                            borderColor: [
                                'rgb(32, 201, 151)', 'rgb(102, 16, 242)',
                                'rgb(253, 126, 20)', 'rgb(23, 162, 184)',
                                'rgb(0, 123, 255)', 'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)', 'rgb(220, 53, 69)',
                                'rgb(108, 117, 125)', 'rgb(52, 58, 64)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round(value / total * 100) : 0;
                                        return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                    }
                                },
                                titleFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 13
                                },
                                padding: 10,
                                boxPadding: 5
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading service chart:', error);
                document.getElementById('serviceChartLoading').classList.add('d-none');
                document.getElementById('serviceChartNoData').classList.remove('d-none');
            });
            }

            // Load Cost Trend Chart
            function loadCostTrendChart(month = 'all', year = 'all', viewMode = 'monthly') {
        fetch(`/api/costs_trend?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('trendChartLoading').classList.add('d-none');

                // Check if there's data to display
                if (data.length === 0) {
                    document.getElementById('trendChartNoData').classList.remove('d-none');
                    if (costTrendChart) {
                        costTrendChart.destroy();
                        costTrendChart = null;
                    }
                    return;
                }

                // Destroy previous chart if it exists
                if (costTrendChart) {
                    costTrendChart.destroy();
                }

                const ctx = document.getElementById('costTrendChart').getContext('2d');
                costTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(item => item.period),
                        datasets: [{
                            label: 'Cost ($)',
                            data: data.map(item => item.cost),
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: 'rgba(255, 193, 7, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: 'rgba(255, 193, 7, 1)',
                            pointHoverBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cost ($)',
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString('en-US');
                                    },
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 12
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: viewMode === 'monthly' ? 'Month' : (viewMode === 'quarterly' ? 'Quarter' : 'Year'),
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                        size: 12
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw || 0;
                                        return `Cost: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    }
                                },
                                titleFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                                    size: 13
                                },
                                padding: 10,
                                boxPadding: 5
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading trend chart:', error);
                document.getElementById('trendChartLoading').classList.add('d-none');
                document.getElementById('trendChartNoData').classList.remove('d-none');
            });
            }

</script>
{% endblock %}
